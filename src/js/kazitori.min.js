/*! kazitori.js - v0.2.1 - 2013-02-22
* https://github.com/glassesfactory/kazitori.js
* Copyright (c) 2013 Eikichi Yamaguchi; Licensed MIT */
var Deffered,EventDispatcher,Kazitori,KazitoriEvent,Rule,VARIABLE_TYPES,delegater,escapeRegExp,genericParam,namedParam,optionalParam,routeStripper,splatParam,trailingSlash,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__indexOf=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1},__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};delegater=function(t,e){return function(){return e.apply(t,arguments)}},trailingSlash=/\/$/,routeStripper=/^[#\/]|\s+$/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,namedParam=/<(\w+|[A-Za-z_]+:\w+)>/g,genericParam=/([A-Za-z_]+):(\w+)/,optionalParam=/\((.*?)\)/g,splatParam=/\*\w+/g,VARIABLE_TYPES=[{name:"int",cast:Number},{name:"string",cast:String}],Kazitori=function(){function t(t){this.observeURLHandler=__bind(this.observeURLHandler,this),this.beforeFailed=__bind(this.beforeFailed,this),this.executeHandlers=__bind(this.executeHandlers,this),this._executeBefores=__bind(this._executeBefores,this),this.beforeComplete=__bind(this.beforeComplete,this);var e,r;this._processStep.status="constructor",this._processStep.args=[t],this.options=t||(t={}),t.routes&&(this.routes=t.routes),this.root=t.root?t.root:"/",this.isTemae=t.isTemae?t.isTemae:!1,this._params={params:[],queries:{},fragment:null},null===this.notFound&&(this.notFound=t.notFound?t.notFound:this.root),r=window,r!==void 0&&(this.location=r.location,this.history=r.history),e=document.docmentMode,this.isOldIE=-1!==r.navigator.userAgent.toLowerCase().indexOf("msie")&&(!e||7>e),this._dispatcher=new EventDispatcher,this._bindBefores(),this._bindRules(),this._bindNotFound();try{Object.defineProperty(this,"params",{enumerable:!0,get:function(){return this._params.params}}),Object.defineProperty(this,"queries",{enumerable:!0,get:function(){return this._params.queries}})}catch(i){throw Error(i)}(null==this.options.isAutoStart||this.options.isAutoStart!==!1)&&this.start()}return t.prototype.VERSION="0.2.1",t.prototype.history=null,t.prototype.location=null,t.prototype.handlers=[],t.prototype.beforeHandlers=[],t.prototype.afterhandlers=[],t.prototype.rootFiles=["index.html","index.htm","index.php","unko.html"],t.prototype.root=null,t.prototype.notFound=null,t.prototype.beforeAnytimeHandler=null,t.prototype.direct=null,t.prototype._params={params:[],fragment:""},t.prototype.beforeFailedHandler=function(){},t.prototype.isBeforeForce=!1,t.prototype.isTemae=!1,t.prototype._changeOptions=null,t.prototype.isNotFoundForce=!1,t.prototype._notFoudn=null,t.prototype.breaker={},t.prototype._dispatcher=null,t.prototype._beforeDeffer=null,t.prototype.fragment=null,t.prototype.lastFragment=null,t.prototype.isUserAction=!1,t.prototype._isFirstRequest=!0,t.prototype.iuResume=!1,t.prototype._processStep={status:"null",args:[]},t.prototype.start=function(e){var r,i,s,n,o;if(this._processStep.status="start",this._processStep.args=[e],t.started)throw Error("mou hazim matteru");return t.started=!0,o=window,this.options=this._extend({},{root:"/"},this.options,e),this._hasPushState=!(!this.history||!this.history.pushState),this._wantChangeHash=this.options.hashChange!==!1,i=this.fragment=this.getFragment(),r=this.location.pathname.replace(/[^\/]$/,"$&/")===this.root,this.isOldIE&&this._wantChangeHash&&(s=document.createElement("iframe"),s.setAttribute("src","javascript:0"),s.setAttribute("tabindex","-1"),s.style.display="none",document.body.appendChild(s),this.iframe=s.contentWindow,this.change(i)),this._addPopStateHandler(),this._hasPushState&&r&&this.location.hash&&(this.fragment=this.lastFragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+this.location.search)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.START,this.fragment)),this.options.silent?void 0:(n=this.root,!this._hasPushState&&r?n=this.root+this.fragment.replace(routeStripper,""):r||(n=this.fragment),this.loadURL(n))},t.prototype.stop=function(){var e;return e=window,e.removeEventListener("popstate",this.observeURLHandler),e.removeEventListener("hashchange",this.observeURLHandler),t.started=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.STOP,this.fragment))},t.prototype.torikazi=function(t){return this.direction(t,"next")},t.prototype.omokazi=function(t){return this.direction(t,"prev")},t.prototype.direction=function(e,r){var i;if(!t.started)return!1;if(i=this.lastFragment,this.lastFragment=this.getFragment(),this.direct=r,this.isUserAction=!0,this._removePopStateHandler(),"prev"===r)this.history.back(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,i,this.lastFragment));else{if("next"!==r)return;this.history.forward(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,i,this.lastFragment))}return this._addPopStateHandler(),this.loadURL(i)},t.prototype.change=function(e,r){var i,s,n,o,a;return t.started?(this._processStep.status="change",this._processStep.args=[e,r],o=this.fragment,r||(r={trigger:r}),this._changeOptions=r,this.isBeforeForce=r.isBeforeForce!==!1,i=this.getFragment(e||""),this.fragment!==i?(this.lastFragment=this.fragment,this.fragment=i,n=this.fragment,a=this.root+i.replace(routeStripper,""),s=this._matchCheck(this.fragment,this.handlers),s===!1&&this.isNotFoundForce===!1?(null!==this.notFound&&(this._notFound.callback(this.fragment),a=this.root+this._notFound.rule.replace(routeStripper,""),this.history[r.replace?"replaceState":"pushState"]({},document.title,a)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND)),void 0):(this.isTemae&&(this.beforeAnytimeHandler||this.beforeHandlers.length>0)?this._executeBefores(i):this._urlChange(i,r),void 0)):void 0):!1},t.prototype.replace=function(t,e){this._processStep.status="replace",this._processStep.args=[t,e],e?e.replace&&e.replace!==!1||(e.replace=!0):e={replace:!0},this.change(framgent,e)},t.prototype._urlChange=function(t,e){var r;if(this._processStep.status="_urlChange",this._processStep.args=[t,e],!this.isResume){if(e||(e=this._changeOptions),r=this.root+this.fragment.replace(routeStripper,""),this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,r);else{if(!this._wantChangeHash)return this.location.assign(r);this._updateHash(this.location,frag,e.replace),this.iframe&&frag!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,frag,e.replace))}return this.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,this.fragment,this.lastFragment)),e.internal&&e.internal===!0&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.INTERNAL_CHANGE,this.fragment,this.lastFragment)),this.loadURL(this.fragment,e)}},t.prototype.reject=function(){this.dispatchEvent(new KazitoriEvent(KazitoriEvent.REJECT,this.fragment)),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer=null},t.prototype.resume=function(){null!=this._beforeDeffer&&this._beforeDeffer.resume(),this.isResume=!0,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.RESUME,this.fragment,this.lastFragment))},t.prototype.restart=function(){null!=this._beforeDeffer&&this._beforeDeffer.restart(),this.isResume=!1,this[this._processStep.status](this._processStep.args),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.RESTART,this.fragment,this.lastFragment))},t.prototype.registerHandler=function(t,e,r,i){var s;return i||(i=r?this._bindFunctions(e):"function"==typeof e?e:this[e]),s=r?this.beforeHandlers:this.handlers,s.unshift(new Rule(t,function(t){var e;return e=this.router.extractParams(this,t),i&&i.apply(this.router,e)},this)),this},t.prototype.loadURL=function(t,e){var r;this._processStep.status="loadURL",this._processStep.args=[t,e],this.isResume||(r=this.fragment=this.getFragment(t),this.isTemae===!1&&(this.beforeAnytimeHandler||this.beforeHandlers.length>0)?this._executeBefores(r):this.executeHandlers())},t.prototype.match=function(t){var e;return e=this._matchCheck(t,this.handlers,!0),e.length>0},t.prototype.beforeComplete=function(){this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.BEFORE_EXECUTED,this.fragment,this.lastFragment)),this.isTemae?(console.log(this._changeOptions),this._urlChange(this.fragment,this._changeOptions)):this.executeHandlers()},t.prototype._executeBefores=function(t){var e,r,i,s,n=this;for(this._processStep.status="_executeBefores",this._processStep.args=[t],this._beforeDeffer=new Deffered,null!=this.beforeAnytimeHandler&&this._beforeDeffer.deffered(function(e){n.beforeAnytimeHandler.callback(t),e.execute(e)}),r=this._matchCheck(t,this.beforeHandlers),i=0,s=r.length;s>i;i++)e=r[i],this._beforeDeffer.deffered(function(r){e.callback(t),r.execute(r)});return this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.execute(this._beforeDeffer)},t.prototype.executeHandlers=function(){var t,e,r,i,s,n=this;if(this._processStep.status="executeHandlers",this._processStep.args=[],!this.isResume){if(r=this._matchCheck(this.fragment,this.handlers),e=!0,r===!1||1>r.length)null!==this.notFound&&this._notFound.callback(this.fragment),e=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND));else if(r.length>1)console.log("too many matched...");else for(i=0,s=r.length;s>i;i++)t=r[i],t.callback(this.fragment);return this._isFirstRequest?(setTimeout(function(){return n._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.FIRST_REQUEST,n.fragment,null)),e?n._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,n.fragment,null)):void 0},0),this._isFirstRequest=!1):e&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,this.fragment,this.lastFragment)),r}},t.prototype.beforeFailed=function(){this.beforeFailedHandler.apply(this,arguments),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this.isBeforeForce&&this.beforeComplete(),this._beforeDeffer=null},t.prototype.observeURLHandler=function(){var t;return t=this.getFragment(),t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.change(t),this.lastFragment===t&&this.isUserAction===!1?this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,t,this.fragment)):this.lastFragment===this.fragment&&this.isUserAction===!1&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,t,this.lastFragment)),this.isUserAction=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,t,this.lastFragment)),this.loadURL(t))},t.prototype._bindRules=function(){var t,e,r,i;if(null!=this.routes)for(t=this._keys(this.routes),r=0,i=t.length;i>r;r++)e=t[r],this.registerHandler(e,this.routes[e],!1)},t.prototype._bindBefores=function(){var t,e,r,i,s;if(null!=this.befores){for(t=this._keys(this.befores),i=0,s=t.length;s>i;i++)r=t[i],this.registerHandler(r,this.befores[r],!0);this.beforeAnytime&&(e=this._bindFunctions(this.beforeAnytime),this.beforeAnytimeHandler={callback:this._binder(function(t){var r;return r=[t],e&&e.apply(this,r)},this)})}},t.prototype._bindNotFound=function(){var t,e,r,i,s,n,o;if(null!=this.notFound){if("string"==typeof this.notFound){for(o=this.handlers,s=0,n=o.length;n>s;s++)if(i=o[s],i.rule==="/"+this.notFound.replace(this.root,""))return this._notFound=i,void 0}else e=this._keys(this.notFound)[0];r=this.notFound[e],t="function"==typeof r?r:this[r],this._notFound=new Rule(e,function(e){var r;return r=this.router.extractParams(this,e),t&&t.apply(this.router,r)},this)}},t.prototype._updateHash=function(t,e,r){var i;r?(i=t.href.replace(/(javascript:|#).*$/,""),t.replace(i+"#"+e)):t.hash="#"+e},t.prototype._matchCheck=function(t,e,r){var i,s,n,o,a,h,p,l,u,c,f;for(null==r&&(r=!1),p=[],u=0,c=e.length;c>u;u++)if(o=e[u],o.rule===t)p.push(o);else if(o.test(t))if(o.isVariable&&o.types.length>0){for(s=this.extractParams(o,t,r),n=[],h=s.length,a=0;h>a;)i=s[a],l=o.types[a],"object"!=typeof i&&(null===l||this._typeCheck(i,l)===!0)&&n.push(!0),a++;f=!!1,__indexOf.call(n,f)>=0&&p.push(o)}else p.push(o);return p.length>0?p:!1},t.prototype.getFragment=function(t){var e,r,i,s,n,o,a;if(null==t)if(this._hasPushState||!this._wantChangeHash){for(t=this.location.pathname,i=!1,e=t,e.match(/^\//)&&(e=e.substr(1)),s=this.root,s.match(/^\//)&&(s=s.substr(1)),a=this.rootFiles,n=0,o=a.length;o>n;n++)r=a[n],(r===e||s+r===e)&&(i=!0);i&&(t=this.root),t+=this.location.search,s=this.root.replace(trailingSlash,""),t.indexOf(s)||(t=t.substr(s.length))}else t=this.getHash();return t},t.prototype.getHash=function(){var t;return t=(window||this).location.href.match(/#(.*)$/),null!=t?t[1]:""},t.prototype.extractParams=function(t,e,r){var i,s,n,o,a,h,p,l,u,c,f,d,_,E;if(null==r&&(r=!1),this._params.params.length>0&&this._params.fragment===e)return this._params.params;if(p=t._regexp.exec(e),this._params.fragment=e,null!=p){if(o=p.slice(1),n=p[p.length-1],n.indexOf("?")>-1){for(a=[],u=n.split("?")[1],f=u.split("&"),_=0,E=f.length;E>_;_++)c=f[_],s=c.split("="),i=s[0],d=s[1]?s[1]:"",d.indexOf("|")>-1&&(d=d.split("|")),h={},h[i]=d,a.push(h);o.pop(),o.push(n.split("?")[0]),l={queries:a},o.push(l),r||(this._params.params=this._getCastedParams(t,o.slice(0)),this._params.queries=l)}else r||(this._params.params=this._getCastedParams(t,o));return o}return this._params.params=[],null},t.prototype._getCastedParams=function(t,e){var r,i,s,n,o,a;if(i=0,!e)return e;if(1>t.types.length)return e;for(s=e.length,r=[];s>i;){if(null===t.types[i])r.push(e[i]);else if("object"==typeof e[i])r.push(e[i]);else for(o=0,a=VARIABLE_TYPES.length;a>o;o++)n=VARIABLE_TYPES[o],t.types[i]===n.name&&r.push(n.cast(e[i]));i++}return r},t.prototype.addEventListener=function(t,e){return this._dispatcher.addEventListener(t,e)},t.prototype.removeEventListener=function(t,e){return this._dispatcher.removeEventListener(t,e)},t.prototype.dispatchEvent=function(t){return this._dispatcher.dispatchEvent(t)},t.prototype._addPopStateHandler=function(){var t;return t=window,this._hasPushState===!0&&t.addEventListener("popstate",this.observeURLHandler),this._wantChangeHash===!0&&__indexOf.call(t,"onhashchange")>=0&&!this.isOldIE?t.addEventListener("hashchange",this.observeURLHandler):void 0},t.prototype._removePopStateHandler=function(){var t;return t=window,t.removeEventListener("popstate",this.observeURLHandler),t.removeEventListener("hashchange",this.observeURLHandler)},t.prototype._slice=Array.prototype.slice,t.prototype._keys=Object.keys||function(t){var e,r;if(t===!Object(t))throw new TypeError("object ja nai");r=[];for(e in t)Object.hasOwnProperty.call(t,e)&&(r[r.length]=e);return r},t.prototype._binder=function(t,e){var r,i;return i=this._slice,r=i.call(arguments,2),function(){return t.apply(e||{},r.concat(i.call(arguments)))}},t.prototype._extend=function(t){return this._each(this._slice.call(arguments,1),function(e){var r,i;if(e){i=[];for(r in e)i.push(t[r]=e[r]);return i}}),t},t.prototype._each=function(t,e,r){var i,s,n,o;if(null!=t){if(i=Array.prototype.forEach,i&&t.forEach===i)return t.forEach(e,r);if(t.length===+t.length)for(s=0,o=t.length;o>s;){if(e.call(r,t[s],s,t)===this.breaker)return;s++}else for(n in t)if(__indexOf.call(t,n)>=0&&e.call(r,t[n],n,t)===this.breaker)return}},t.prototype._bindFunctions=function(t){var e,r,i,s,n,o,a,h,p,l,u;for("string"==typeof t&&(t=t.split(",")),e=[],l=0,u=t.length;u>l;l++){if(n=t[l],s=this[n],null==s)if(h=n.split("."),h.length>1){for(i=window[h[0]],o=1,a=h.length;a>o&&(p=i[h[o]],null!=p);)i=p,o++;s=i}else s=window[n];null!=s&&e.push(s)}return r=function(t){var r,i;for(r=0,i=e.length;i>r;r++)s=e[r],s.apply(this,[t])}},t.prototype._typeCheck=function(t,e){var r,i,s,n;for(r=!1,s=0,n=VARIABLE_TYPES.length;n>s;s++)i=VARIABLE_TYPES[s],e.toLowerCase()===i.name&&i.cast(t)&&(r=!0);return r},t}(),Rule=function(){function t(t,e,r){var i,s,n,o,a,h;if(this.rule=t,this.callback=e,this._regexp=this._ruleToRegExp(t),this.router=r,this.types=[],n=RegExp(namedParam),s=t.match(n),null!==s)for(this.isVariable=!0,a=0,h=s.length;h>a;a++)i=s[a],o=i.match(genericParam)||null,this.types.push(null!==o?o[1]:null)}return t.prototype.rule=null,t.prototype._regexp=null,t.prototype.callback=null,t.prototype.name="",t.prototype.router=null,t.prototype.isVariable=!1,t.prototype.types=[],t.prototype.test=function(t){return this._regexp.test(t)},t.prototype._ruleToRegExp=function(t){var e;return e=t.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,"([^/]+)").replace(splatParam,"(.*?)"),RegExp("^"+e+"$")},t}(),EventDispatcher=function(){function t(){}return t.prototype.listeners={},t.prototype.addEventListener=function(t,e){void 0===this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].indexOf(-1===e)&&this.listeners[t].push(e)},t.prototype.removeEventListener=function(t,e){var r,i,s,n;s=0;for(n in this.listeners)s++;if(!(1>s)&&(r=this.listeners[t]))for(i=0,s=r.length;s>i;){if(r[i]===e){1===s?delete this.listeners[t]:r.splice(i,1);break}i++}},t.prototype.dispatchEvent=function(t){var e,r,i,s;if(e=this.listeners[t.type],void 0!==e)for(t.target=this,i=0,s=e.length;s>i;i++)r=e[i],r.call(this,t)},t}(),Deffered=function(t){function e(){this.queue=[],this.isResume=!1}return __extends(e,t),e.prototype.queue=[],e.prototype.isResume=!1,e.prototype.deffered=function(t){return this.queue.push(t),this},e.prototype.execute=function(){var t;if(!this.isResume)try{if(t=this.queue.shift(),t&&t.apply(this,arguments),1>this.queue.length)return this.queue=[],this.dispatchEvent(new KazitoriEvent(KazitoriEvent.TASK_QUEUE_COMPLETE))}catch(e){return this.reject(e)}},e.prototype.reject=function(t){var e;return e=t?t:"user reject",this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_FAILED,index:this.index,message:e})},e.prototype.resume=function(){this.isResume=!0},e.prototype.restart=function(){this.isResume=!1,this.execute()},e}(EventDispatcher),KazitoriEvent=function(){function t(t,e,r){this.type=t,this.next=e,this.prev=r}return t.prototype.next=null,t.prototype.prev=null,t.prototype.type=null,t.prototype.clone=function(){return new t(this.type,this.next,this.prev)},t.prototype.toString=function(){return"KazitoriEvent :: type:"+this.type+" next:"+(this.next+"")+" prev:"+(this.prev+"")},t}(),KazitoriEvent.TASK_QUEUE_COMPLETE="task_queue_complete",KazitoriEvent.TASK_QUEUE_FAILED="task_queue_failed",KazitoriEvent.CHANGE="change",KazitoriEvent.EXECUTED="executed",KazitoriEvent.BEFORE_EXECUTED="before_executed",KazitoriEvent.INTERNAL_CHANGE="internal_change",KazitoriEvent.USER_CHANGE="user_change",KazitoriEvent.PREV="prev",KazitoriEvent.NEXT="next",KazitoriEvent.REJECT="reject",KazitoriEvent.NOT_FOUND="not_found",KazitoriEvent.START="start",KazitoriEvent.STOP="stop",KazitoriEvent.RESUME="resume",KazitoriEvent.RESTART="restart",KazitoriEvent.FIRST_REQUEST="first_request",Kazitori.started=!1;