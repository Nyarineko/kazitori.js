var Deffered,EventDispatcher,Kazitori,KazitoriEvent,Rule,VARIABLE_TYPES,delegater,escapeRegExp,genericParam,namedParam,optionalParam,routeStripper,splatParam,trailingSlash,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};delegater=function(e,t){return function(){return t.apply(e,arguments)}},trailingSlash=/\/$/,routeStripper=/^[#\/]|\s+$/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,namedParam=/<(\w+|[A-Za-z_]+:\w+)>/g,genericParam=/([A-Za-z_]+):(\w+)/,optionalParam=/\((.*?)\)/g,splatParam=/\*\w+/g,VARIABLE_TYPES=[{name:"int",cast:Number},{name:"string",cast:String}],Kazitori=function(){function e(e){this.observeURLHandler=__bind(this.observeURLHandler,this),this.beforeFailed=__bind(this.beforeFailed,this),this.executeHandlers=__bind(this.executeHandlers,this),this.beforeComplete=__bind(this.beforeComplete,this);var t,n;this.options=e||(e={}),e.routes&&(this.routes=e.routes),this.root=e.root?e.root:"/",this.notFound=e.notFound?e.notFound:this.root,n=window,typeof n!="undefined"&&(this.location=n.location,this.history=n.history),t=document.docmentMode,this.isOldIE=n.navigator.userAgent.toLowerCase().indexOf("msie")!==-1&&(!t||t<7),this._dispatcher=new EventDispatcher,this._bindBefores(),this._bindRules(),(this.options.isAutoStart==null||this.options.isAutoStart!==!1)&&this.start();return}return e.prototype.VERSION="0.2",e.prototype.history=null,e.prototype.location=null,e.prototype.handlers=[],e.prototype.beforeHandlers=[],e.prototype.afterhandlers=[],e.prototype.rootFile=["index.html","index.htm","index.php","unko.html"],e.prototype.root=null,e.prototype.notFound=null,e.prototype.beforeAnytimeHandler=null,e.prototype.direct=null,e.prototype.beforeFailedHandler=function(){},e.prototype.isBeforeForce=!1,e.prototype.isNotFoundForce=!1,e.prototype.breaker={},e.prototype._dispatcher=null,e.prototype._beforeDeffer=null,e.prototype.fragment=null,e.prototype.lastFragment=null,e.prototype.isUserAction=!1,e.prototype._isFirstRequest=!0,e.prototype.start=function(t){var n,r,i,s,o;if(e.started)throw new Error("mou hazim matteru");e.started=!0,o=window,this.options=this._extend({},{root:"/"},this.options,t),this._hasPushState=!!this.history&&!!this.history.pushState,this._wantChangeHash=this.options.hashChange!==!1,r=this.fragment=this.getFragment(),n=this.location.pathname.replace(/[^\/]$/,"$&/")===this.root,this.isOldIE&&this._wantChangeHash&&(i=document.createElement("iframe"),i.setAttribute("src","javascript:0"),i.setAttribute("tabindex","-1"),i.style.display="none",document.body.appendChild(i),this.iframe=i.contentWindow,this.change(r)),this._addPopStateHandler(),this._hasPushState&&n&&this.location.hash&&(this.fragment=this.lastFragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+this.location.search)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.START,this.fragment));if(!this.options.silent)return s=this.root,!this._hasPushState&&n?s=this.root+this.fragment.replace(routeStripper,""):n||(s=this.fragment),this.loadURL(s)},e.prototype.stop=function(){var t;return t=window,t.removeEventListener("popstate",this.observeURLHandler),t.removeEventListener("hashchange",this.observeURLHandler),e.started=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.STOP,this.fragment))},e.prototype.torikazi=function(e){return this.direction(e,"next")},e.prototype.omokazi=function(e){return this.direction(e,"prev")},e.prototype.direction=function(t,n){var r;if(!e.started)return!1;r=this.lastFragment,this.lastFragment=this.getFragment(),this.direct=n,this.isUserAction=!0,this._removePopStateHandler();if(n==="prev")this.history.back(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,r,this.lastFragment));else{if(n!=="next")return;this.history.forward(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,r,this.lastFragment))}return this._addPopStateHandler(),this.loadURL(r)},e.prototype.change=function(t,n){var r,i,s,o,u;if(!e.started)return!1;o=this.fragment,n||(n={trigger:n}),this.isBeforeForce=n.isBeforeForce!==!1,r=this.getFragment(t||"");if(this.fragment===r)return;this.lastFragment=this.fragment,this.fragment=r,s=this.fragment,u=this.root+r.replace(routeStripper,""),i=this._matchCheck(this.fragment,this.handlers);if(i===!1&&this.isNotFoundForce===!1){this.notFound!==null&&this.change(this.notFound),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND));return}if(this._hasPushState)this.history[n.replace?"replaceState":"pushState"]({},document.title,u);else{if(!this._wantChangeHash)return this.location.assign(u);this._updateHash(this.location,r,n.replace),this.iframe&&r!==this.getFragment(this.getHash(this.iframe))&&(n.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,r,n.replace))}this.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,s,o)),n.internal&&n.internal===!0&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.INTERNAL_CHANGE,s,o)),this.loadURL(r,n)},e.prototype.replace=function(t,n){var r;if(!e.started)return!1;r=this.fragment,n||(n={trigger:n})},e.prototype.reject=function(){this.dispatchEvent(new KazitoriEvent(KazitoriEvent.REJECT,this.fragment)),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer=null},e.prototype.registerHandler=function(e,t,n,r){var i;return r||(n?r=this._bindFunctions(t):typeof t=="function"?r=t:r=this[t]),i=n?this.beforeHandlers:this.handlers,i.unshift(new Rule(e,function(e){var t;return t=this._extractParams(e),t=this._getCastedParams(t),r&&r.apply(this.router,t)},this)),this},e.prototype.loadURL=function(e,t){var n,r,i,s,o,u=this;n=this.fragment=this.getFragment(e);if(this.beforeAnytimeHandler||this.beforeHandlers.length>0){this._beforeDeffer=new Deffered,this.beforeAnytimeHandler!=null&&this._beforeDeffer.deffered(function(e){u.beforeAnytimeHandler.callback(n),e.execute(e)}),i=this._matchCheck(n,this.beforeHandlers);for(s=0,o=i.length;s<o;s++)r=i[s],this._beforeDeffer.deffered(function(e){r.callback(n),e.execute(e)});this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.execute(this._beforeDeffer)}else this.executeHandlers()},e.prototype.beforeComplete=function(e){this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.BEFORE_EXECUTED,this.fragment,this.lastFragment)),this.executeHandlers()},e.prototype.executeHandlers=function(){var e,t,n,r,i,s=this;n=this._matchCheck(this.fragment,this.handlers),t=!0;if(n.length<1)this.notFound!==null&&this.loadURL(this.notFound),t=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND));else if(n.length>1)console.log("too many matched...");else for(r=0,i=n.length;r<i;r++)e=n[r],e.callback(this.fragment);return this._isFirstRequest?(setTimeout(function(){s._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.FIRST_REQUEST,s.fragment,null));if(t)return s._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,s.fragment,null))},0),this._isFirstRequest=!1):t&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,this.fragment,this.lastFragment)),n},e.prototype.beforeFailed=function(e){this.beforeFailedHandler.apply(this,arguments),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this.isBeforeForce&&this.beforeComplete(),this._beforeDeffer=null},e.prototype.observeURLHandler=function(e){var t;return t=this.getFragment(),t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.change(t),this.lastFragment===t&&this.isUserAction===!1?this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,t,this.fragment)):this.lastFragment===this.fragment&&this.isUserAction===!1&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,t,this.lastFragment)),this.isUserAction=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,t,this.lastFragment)),this.loadURL(t))},e.prototype._bindRules=function(){var e,t,n,r;if(this.routes==null)return;e=this._keys(this.routes);for(n=0,r=e.length;n<r;n++)t=e[n],this.registerHandler(t,this.routes[t],!1)},e.prototype._bindBefores=function(){var e,t,n,r,i;if(this.befores==null)return;e=this._keys(this.befores);for(r=0,i=e.length;r<i;r++)n=e[r],this.registerHandler(n,this.befores[n],!0);this.beforeAnytime&&(t=this._bindFunctions(this.beforeAnytime),this.beforeAnytimeHandler={callback:this._binder(function(e){var n;return n=[e],t&&t.apply(this,n)},this)})},e.prototype._updateHash=function(e,t,n){var r;n?(r=e.href.replace(/(javascript:|#).*$/,""),e.replace(r+"#"+t)):e.hash="#"+t},e.prototype._matchCheck=function(e,t){var n,r,i,s,o,u,a,f,l,c,h;a=[];for(l=0,c=t.length;l<c;l++){s=t[l];if(s.rule===e)a.push(s);else if(s.test(e))if(s.isVariable&&s.types.length>0){r=s._extractParams(e),i=[],u=r.length,o=0;while(o<u)n=r[o],f=s.types[o],typeof n!="object"&&(f===null||this._typeCheck(n,f)===!0)&&i.push(!0),o++;(h=!0,__indexOf.call(i,h)>=0)&&a.push(s)}else a.push(s)}return a.length>0?a:!1},e.prototype.getFragment=function(e){var t,n,r,i,s,o,u;if(e==null)if(this._hasPushState||!this._wantChangeHash){e=this.location.pathname,r=!1,t=e.replace("/",""),u=this.rootFile;for(s=0,o=u.length;s<o;s++)n=u[s],n===t&&(r=!0);r&&(e=this.root),e+=this.location.search,i=this.root.replace(trailingSlash,""),e.indexOf(i)||(e=e.substr(i.length))}else e=this.getHash();return e},e.prototype.getHash=function(){var e;return e=(window||this).location.href.match(/#(.*)$/),e!=null?e[1]:""},e.prototype.addEventListener=function(e,t){return this._dispatcher.addEventListener(e,t)},e.prototype.removeEventListener=function(e,t){return this._dispatcher.removeEventListener(e,t)},e.prototype.dispatchEvent=function(e){return this._dispatcher.dispatchEvent(e)},e.prototype._addPopStateHandler=function(){var e;e=window,this._hasPushState===!0&&e.addEventListener("popstate",this.observeURLHandler);if(this._wantChangeHash===!0&&__indexOf.call(e,"onhashchange")>=0&&!this.isOldIE)return e.addEventListener("hashchange",this.observeURLHandler)},e.prototype._removePopStateHandler=function(){var e;return e=window,e.removeEventListener("popstate",this.observeURLHandler),e.removeEventListener("hashchange",this.observeURLHandler)},e.prototype._slice=Array.prototype.slice,e.prototype._keys=Object.keys||function(e){var t,n;if(e===!Object(e))throw new TypeError("object ja nai");n=[];for(t in e)Object.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n},e.prototype._binder=function(e,t){var n,r;return r=this._slice,n=r.call(arguments,2),function(){return e.apply(t||{},n.concat(r.call(arguments)))}},e.prototype._extend=function(e){return this._each(this._slice.call(arguments,1),function(t){var n,r;if(t){r=[];for(n in t)r.push(e[n]=t[n]);return r}}),e},e.prototype._each=function(e,t,n){var r,i,s,o;if(e==null)return;r=Array.prototype.forEach;if(r&&e.forEach===r)return e.forEach(t,n);if(e.length===+e.length){i=0,o=e.length;while(i<o){if(t.call(n,e[i],i,e)===this.breaker)return;i++}}else for(s in e)if(__indexOf.call(e,s)>=0&&t.call(n,e[s],s,e)===this.breaker)return},e.prototype._bindFunctions=function(e){var t,n,r,i,s,o,u,a,f,l,c;typeof e=="string"&&(e=e.split(",")),t=[];for(l=0,c=e.length;l<c;l++){s=e[l],i=this[s];if(i==null){a=s.split(".");if(a.length>1){r=window[a[0]],o=1,u=a.length;while(o<u){f=r[a[o]];if(f==null)break;r=f,o++}i=r}else i=window[s]}i!=null&&t.push(i)}return n=function(e){var n,r;for(n=0,r=t.length;n<r;n++)i=t[n],i.apply(this,[e])},n},e.prototype._typeCheck=function(e,t){var n,r,i,s;n=!1;for(i=0,s=VARIABLE_TYPES.length;i<s;i++)r=VARIABLE_TYPES[i],t.toLowerCase()===r.name&&r.cast(e)&&(n=!0);return n},e}(),Rule=function(){function e(e,t,n){var r,i,s,o,u,a;this.rule=e,this.callback=t,this._regexp=this._ruleToRegExp(e),this.router=n,this.types=[],s=new RegExp(namedParam),i=e.match(s);if(i!==null){this.isVariable=!0;for(u=0,a=i.length;u<a;u++)r=i[u],o=r.match(genericParam)||null,this.types.push(o!==null?o[1]:null)}}return e.prototype.rule=null,e.prototype._regexp=null,e.prototype.callback=null,e.prototype.name="",e.prototype.router=null,e.prototype.isVariable=!1,e.prototype.types=[],e.prototype.test=function(e){return this._regexp.test(e)},e.prototype._extractParams=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;u=this._regexp.exec(e);if(u!=null){i=u.slice(1),r=u[u.length-1];if(r.indexOf("?")>-1){s=[],a=r.split("?")[1],l=a.split("&");for(h=0,p=l.length;h<p;h++)f=l[h],n=f.split("="),t=n[0],c=n[1]?n[1]:"",c.indexOf("|")>-1&&(c=c.split("|")),o={},o[t]=c,s.push(o);i.pop(),i.push(r.split("?")[0]),i.push({queries:s})}return i}return null},e.prototype._getCastedParams=function(e){var t,n,r,i,s,o;n=0,r=e.length,t=[];while(n<r){if(this.types[n]===null)t.push(e[n]);else if(typeof e[n]=="object")t.push(e[n]);else for(s=0,o=VARIABLE_TYPES.length;s<o;s++)i=VARIABLE_TYPES[s],this.types[n]===i.name&&t.push(i.cast(e[n]));n++}return t},e.prototype._ruleToRegExp=function(e){var t;return t=e.replace(escapeRegExp,"\\$&"),t=t.replace(optionalParam,"(?:$1)?"),t=t.replace(namedParam,"([^/]+)"),t=t.replace(splatParam,"(.*?)"),new RegExp("^"+t+"$")},e}(),EventDispatcher=function(){function e(){}return e.prototype.listeners={},e.prototype.addEventListener=function(e,t){this.listeners[e]===void 0&&(this.listeners[e]=[]),this.listeners[e].indexOf(t===-1)&&this.listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){var n,r,i,s;i=0;for(s in this.listeners)i++;if(i<1)return;n=this.listeners[e];if(!n)return;r=0,i=n.length;while(r<i){if(n[r]===t){i===1?delete this.listeners[e]:n.splice(r,1);break}r++}},e.prototype.dispatchEvent=function(e){var t,n,r,i;t=this.listeners[e.type];if(t!==void 0){e.target=this;for(r=0,i=t.length;r<i;r++)n=t[r],n.call(this,e)}},e}(),Deffered=function(e){function t(){this.queue=[]}return __extends(t,e),t.prototype.queue=[],t.prototype.deffered=function(e){return this.queue.push(e),this},t.prototype.execute=function(){var e;try{e=this.queue.shift(),e&&e.apply(this,arguments);if(this.queue.length<1)return this.queue=[],this.dispatchEvent(new KazitoriEvent(KazitoriEvent.TASK_QUEUE_COMPLETE))}catch(t){return this.reject(t)}},t.prototype.reject=function(e){var t;return t=e?e:"user reject",this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_FAILED,index:this.index,message:t})},t}(EventDispatcher),KazitoriEvent=function(){function e(e,t,n){this.type=e,this.next=t,this.prev=n}return e.prototype.next=null,e.prototype.prev=null,e.prototype.type=null,e.prototype.clone=function(){return new e(this.type,this.next,this.prev)},e.prototype.toString=function(){return"KazitoriEvent :: type:"+this.type+" next:"+String(this.next)+" prev:"+String(this.prev)},e}(),KazitoriEvent.TASK_QUEUE_COMPLETE="task_queue_complete",KazitoriEvent.TASK_QUEUE_FAILED="task_queue_failed",KazitoriEvent.CHANGE="change",KazitoriEvent.EXECUTED="executed",KazitoriEvent.BEFORE_EXECUTED="before_executed",KazitoriEvent.INTERNAL_CHANGE="internal_change",KazitoriEvent.USER_CHANGE="user_change",KazitoriEvent.PREV="prev",KazitoriEvent.NEXT="next",KazitoriEvent.REJECT="reject",KazitoriEvent.NOT_FOUND="not_found",KazitoriEvent.START="start",KazitoriEvent.STOP="stop",KazitoriEvent.FIRST_REQUEST="first_request",Kazitori.started=!1;