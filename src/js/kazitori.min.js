var Deffered,EventDispatcher,Kazitori,KazitoriEvent,Rule,VARIABLE_TYPES,delegater,escapeRegExp,genericParam,namedParam,optionalParam,routeStripper,splatParam,trailingSlash,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};delegater=function(e,t){return function(){return t.apply(e,arguments)}},trailingSlash=/\/$/,routeStripper=/^[#\/]|\s+$/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,namedParam=/<(\w+|[A-Za-z_]+:\w+)>/g,genericParam=/([A-Za-z_]+):(\w+)/,optionalParam=/\((.*?)\)/g,splatParam=/\*\w+/g,VARIABLE_TYPES=[{name:"int",cast:Number},{name:"string",cast:String}],Kazitori=function(){function e(e){this.observeURLHandler=__bind(this.observeURLHandler,this),this.beforeFaild=__bind(this.beforeFaild,this),this.executeHandlers=__bind(this.executeHandlers,this),this.beforeComplete=__bind(this.beforeComplete,this);var t,n;this.options=e||(e={}),e.routes&&(this.routes=e.routes),this.root=e.root?e.root:"/",this.notFound=e.notFound?e.notFound:this.root,n=window,typeof n!="undefined"&&(this.location=n.location,this.history=n.history),t=document.docmentMode,this.isOldIE=n.navigator.userAgent.toLowerCase().indexOf("msie")!==-1&&(!t||t<7),this._dispatcher=new EventDispatcher,this._bindBefores(),this._bindRules(),(__indexOf.call(e,"isAutoStart")<0||e.isAutoStart!==!1)&&this.start();return}return e.prototype.VERSION="0.1.3",e.prototype.history=null,e.prototype.location=null,e.prototype.handlers=[],e.prototype.beforeHandlers=[],e.prototype.afterhandlers=[],e.prototype.root=null,e.prototype.notFound=null,e.prototype.beforeAnytimeHandler=null,e.prototype.direct=null,e.prototype.beforeFaildHandler=function(){},e.prototype.isBeforeForce=!1,e.prototype.breaker={},e.prototype._dispatcher=null,e.prototype._beforeDeffer=null,e.prototype._prevFragment=null,e.prototype.start=function(t){var n,r,i,s;if(e.started)throw new Error("mou hazim matteru");e.started=!0,s=window,this.options=this._extend({},{root:"/"},this.options,t),this._hasPushState=!!this.history&&!!this.history.pushState,this._wantChangeHash=this.options.hashChange!==!1,r=this.getFragment(),n=this.location.pathname.replace(/[^\/]$/,"$&/")===this.root,this.isOldIE&&this._wantChangeHash&&(i=document.createElement("iframe"),i.setAttribute("src","javascript:0"),i.setAttribute("tabindex","-1"),i.style.display="none",document.body.appendChild(i),this.iframe=i.contentWindow,this.change(r)),this._hasPushState===!0?s.addEventListener("popstate",this.observeURLHandler):this._wantChangeHash===!0&&__indexOf.call(s,"onhashchange")>=0&&!this.isOldIE&&s.addEventListener("hashchange",this.observeURLHandler),this._hasPushState&&n&&this.location.hash&&(this.fragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+this.location.search)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.START,this.fragment));if(!this.options.silent)return this.loadURL()},e.prototype.stop=function(){var t;return t=window,t.removeEventListener("popstate",this.observeURLHandler),t.removeEventListener("hashchange",this.observeURLHandler),e.started=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.STOP,this.fragment))},e.prototype.torikazi=function(e){return this.direction(e,"next")},e.prototype.omokazi=function(e){return this.direction(e,"prev")},e.prototype.direction=function(t,n){if(!e.started)return!1;this._prevFragment=this.getFragment(),this.direct=n;if(n==="prev")return this.history.back();if(n==="next")return this.history.forward()},e.prototype.change=function(t,n){var r,i,s,o;if(!e.started)return!1;s=this.fragment,n||(n={trigger:n}),r=this.getFragment(t||"");if(this.fragment===r)return;this.fragment=r,i=this.fragment,o=this.root+r.replace(routeStripper,"");if(this._matchCheck(this.fragment)===!1){this.notFound!==null&&this.change(this.notFound),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND));return}if(this._hasPushState)this.history[n.replace?"replaceState":"pushState"]({},document.title,o);else{if(!this._wantChangeHash)return this.location.assign(o);this._updateHash(this.location,r,n.replace),this.iframe&&r!==this.getFragment(this.getHash(this.iframe))&&(n.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,r,n.replace))}this.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,i,s)),this.loadURL(r)},e.prototype.reject=function(){this.dispatchEvent({type:KazitoriEvent.REJECT}),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILD,this.beforeFaild),this._beforeDeffer=null},e.prototype.registHandler=function(e,t,n,r){var i;return r||(n?r=this._bindFunctions(t):typeof t=="function"?r=t:r=this[t]),i=n?this.beforeHandlers:this.handlers,i.unshift(new Rule(e,function(e){var t;return t=this._extractParams(e),r&&r.apply(this.router,t)},this)),this},e.prototype.loadURL=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v=this;i=this.fragment=this.getFragment(e),a=[];if(this.beforeAnytimeHandler||this.beforeHandlers.length>0){this._beforeDeffer=new Deffered,this._beforeDeffer.queue=[],this._beforeDeffer.index=-1,this.beforeAnytimeHandler!=null&&this._beforeDeffer.deffered(function(e){v.beforeAnytimeHandler.callback(i),e.execute(e)}),l=0,p=this.beforeHandlers;for(c=0,h=p.length;c<h;c++){s=p[c];if(s.rule===i)this._beforeDeffer.deffered(function(e){s.callback(i),e.execute(e)});else{if(s.test(i)!==!0)return this.executeHandlers();if(s.isVariable&&s.types.length>0){n=s._extractParams(this.fragment),r=[],u=n.length,o=0;while(o<u)t=n[o],f=s.types[o],(f===null||this._typeCheck(t,f)===!0)&&r.push(!0),o++;(d=!0,__indexOf.call(r,d)>=0)&&this._beforeDeffer.deffered(function(e){s.callback(i),e.execute(e)})}else this._beforeDeffer.deffered(function(e){s.callback(i),e.execute(e)})}}return this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_FAILD,this.beforeFaild),this._beforeDeffer.execute(this._beforeDeffer)}return this.executeHandlers()},e.prototype.beforeComplete=function(e){return this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILD,this.beforeFaild),this._beforeDeffer.queue=[],this._beforeDeffer.index=-1,this.executeHandlers()},e.prototype.executeHandlers=function(){var e,t,n,r,i,s,o,u,a,f,l,c;o=[],l=this.handlers;for(a=0,f=l.length;a<f;a++){r=l[a];if(r.rule===this.fragment)return r.callback(this.fragment),o.push(!0),o;if(r.test(this.fragment))if(r.isVariable&&r.types.length>0){t=r._extractParams(this.fragment),n=[],s=t.length,i=0;while(i<s)e=t[i],u=r.types[i],(u===null||this._typeCheck(e,u)===!0)&&n.push(!0),i++;if(c=!0,__indexOf.call(n,c)>=0)r.callback(this.fragment),o.push(!0)}else r.callback(this.fragment),o.push(!0)}return o.length<1&&(this.notFound!==null&&this.loadURL(this.notFound),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND))),o},e.prototype.beforeFaild=function(e){return this.beforeFaildHandler.apply(this,arguments),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILD,this.beforeFaild),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this.isBeforeForce&&this.beforeComplete(),this._beforeDeffer=null},e.prototype.observeURLHandler=function(e){var t;return t=this.getFragment(),t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.change(t),this.direct==="prev"?this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,t,this._prevFragment)):this.direct==="next"&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,t,this._prevFragment)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,t,this._prevFragment)),this.loadURL(t))},e.prototype._bindRules=function(){var e,t,n,r;if(this.routes==null)return;e=this._keys(this.routes);for(n=0,r=e.length;n<r;n++)t=e[n],this.registHandler(t,this.routes[t],!1)},e.prototype._bindBefores=function(){var e,t,n,r,i;if(this.befores==null)return;e=this._keys(this.befores);for(r=0,i=e.length;r<i;r++)n=e[r],this.registHandler(n,this.befores[n],!0);this.beforeAnytime&&(t=this._bindFunctions(this.beforeAnytime),this.beforeAnytimeHandler={callback:this._binder(function(e){var n;return n=[e],t&&t.apply(this,n)},this)})},e.prototype._updateHash=function(e,t,n){var r;n?(r=e.href.replace(/(javascript:|#).*$/,""),e.replace(r+"#"+t)):e.hash="#"+t},e.prototype._matchCheck=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;u=[],c=this.handlers;for(f=0,l=c.length;f<l;f++){i=c[f],i.rule===e&&u.push(!0);if(i.test(e))if(i.isVariable&&i.types.length>0){n=i._extractParams(e),r=[],o=n.length,s=0;while(s<o)t=n[s],a=i.types[s],(a===null||this._typeCheck(t,a)===!0)&&r.push(!0),s++;(h=!0,__indexOf.call(r,h)>=0)&&u.push(!0)}else u.push(!0)}return __indexOf.call(u,!0)>=0?!0:!1},e.prototype.getFragment=function(e){var t;return e==null&&(this._hasPushState||!this._wantChangeHash?(e=this.location.pathname,t=this.root.replace(trailingSlash,""),e.indexOf(t)||(e=e.substr(t.length))):e=this.getHash()),e},e.prototype.getHash=function(){var e;return e=(window||this).location.href.match(/#(.*)$/),e!=null?e[1]:""},e.prototype._extractParams=function(e,t,n){var r;return r=e.exec(n),r!=null?r.slice(1):null},e.prototype.addEventListener=function(e,t){return this._dispatcher.addEventListener(e,t)},e.prototype.removeEventListener=function(e,t){return this._dispatcher.removeEventListener(e,t)},e.prototype.dispatchEvent=function(e){return this._dispatcher.dispatchEvent(e)},e.prototype._slice=Array.prototype.slice,e.prototype._keys=Object.keys||function(e){var t,n;if(e===!Object(e))throw new TypeError("object ja nai");n=[];for(t in e)Object.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n},e.prototype._binder=function(e,t){var n,r;return r=this._slice,n=r.call(arguments,2),function(){return e.apply(t||{},n.concat(r.call(arguments)))}},e.prototype._extend=function(e){return this._each(this._slice.call(arguments,1),function(t){var n,r;if(t){r=[];for(n in t)r.push(e[n]=t[n]);return r}}),e},e.prototype._each=function(e,t,n){var r,i,s,o;if(e==null)return;r=Array.prototype.forEach;if(r&&e.forEach===r)return e.forEach(t,n);if(e.length===+e.length){i=0,o=e.length;while(i<o){if(t.call(n,e[i],i,e)===this.breaker)return;i++}}else for(s in e)if(__indexOf.call(e,s)>=0&&t.call(n,e[s],s,e)===this.breaker)return},e.prototype._bindFunctions=function(e){var t,n,r,i,s,o,u,a,f,l,c;typeof e=="string"&&(e=e.split(",")),t=[];for(l=0,c=e.length;l<c;l++){s=e[l],i=this[s];if(i==null){a=s.split(".");if(a.length>1){r=window[a[0]],o=1,u=a.length;while(o<u){f=r[a[o]];if(f==null)break;r=f,o++}i=r}else i=window[s]}i!=null&&t.push(i)}return n=function(e){var n,r;for(n=0,r=t.length;n<r;n++)i=t[n],i.apply(this,[e])},n},e.prototype._typeCheck=function(e,t){var n,r,i,s;n=!1;for(i=0,s=VARIABLE_TYPES.length;i<s;i++)r=VARIABLE_TYPES[i],t.toLowerCase()===r.name&&r.cast(e)&&(n=!0);return n},e}(),Rule=function(){function e(e,t,n){var r,i,s,o,u,a;this.rule=e,this.callback=t,this._regexp=this._ruleToRegExp(e),this.router=n,this.types=[],s=new RegExp(namedParam),i=e.match(s);if(i!==null){this.isVariable=!0;for(u=0,a=i.length;u<a;u++)r=i[u],o=r.match(genericParam)||null,this.types.push(o!==null?o[1]:null)}}return e.prototype.rule=null,e.prototype._regexp=null,e.prototype.callback=null,e.prototype.router=null,e.prototype.isVariable=!1,e.prototype.types=[],e.prototype.test=function(e){return this._regexp.test(e)},e.prototype._extractParams=function(e){var t;return t=this._regexp.exec(e),t!=null?t.slice(1):null},e.prototype._ruleToRegExp=function(e){var t;return t=e.replace(escapeRegExp,"\\$&"),t=t.replace(optionalParam,"(?:$1)?"),t=t.replace(namedParam,"([^/]+)"),t=t.replace(splatParam,"(.*?)"),new RegExp("^"+t+"$")},e}(),EventDispatcher=function(){function e(){}return e.prototype.listeners={},e.prototype.addEventListener=function(e,t){this.listeners[e]===void 0&&(this.listeners[e]=[]),this.listeners[e].indexOf(t===-1)&&this.listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){var n;n=this.listeners[e].indexOf(t),n!==-1&&this.listeners[e].splice(n,1)},e.prototype.dispatchEvent=function(e){var t,n,r,i;t=this.listeners[e.type];if(t!==void 0){e.target=this;for(r=0,i=t.length;r<i;r++)n=t[r],n.call(this,e)}},e}(),Deffered=function(e){function t(){this.queue=[],this.index=-1}return __extends(t,e),t.prototype.queue=[],t.prototype.index=-1,t.prototype.deffered=function(e){return this.queue.push(e),this},t.prototype.execute=function(){this.index++;try{if(this.queue[this.index]){this.queue[this.index].apply(this,arguments);if(this.queue.length===this.index)return this.queue=[],this.index=-1,this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_COMPLETE})}}catch(e){return this.reject(e)}},t.prototype.reject=function(e){return this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_FAILD,index:this.index,message:e.message})},t}(EventDispatcher),KazitoriEvent=function(){function e(e,t,n){this.type=e,this.next=t,this.prev=n}return e.prototype.next=null,e.prototype.prev=null,e.prototype.type=null,e.prototype.clone=function(){return new e(this.type,this.next,this.prev)},e.prototype.toString=function(){return"KazitoriEvent :: type:"+this.type+" next:"+String(this.next)+" prev:"+String(this.prev)},e}(),KazitoriEvent.TASK_QUEUE_COMPLETE="task_queue_complete",KazitoriEvent.TASK_QUEUE_FAILD="task_queue_faild",KazitoriEvent.CHANGE="change",KazitoriEvent.INTERNAL_CHANGE="internal_change",KazitoriEvent.USER_CHANGE="user_change",KazitoriEvent.PREV="prev",KazitoriEvent.NEXT="next",KazitoriEvent.REJECT="reject",KazitoriEvent.NOT_FOUND="not_found",KazitoriEvent.START="start",KazitoriEvent.STOP="stop",Kazitori.started=!1;